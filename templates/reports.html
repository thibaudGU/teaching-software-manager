{% extends "base.html" %}

{% block content %}
<h1>Rapports et Notifications</h1>

<div class="report-section">
    <h2>Envoyer des Rappels de R√©vision</h2>
    <p>Envoyer des emails de rappel de r√©vision logicielle aux enseignants.</p>
    
    <div class="instructors-checklist">
        {% for inst_id, instructor in instructors.items() %}
        <div class="instructor-item">
            <input type="checkbox" id="inst-{{ inst_id }}" class="instructor-checkbox" value="{{ inst_id }}">
            <label for="inst-{{ inst_id }}">
                <strong>{{ instructor.name }}</strong><br>
                <small>{{ instructor.email }}</small>
            </label>
        </div>
        {% endfor %}
    </div>
    
    <div class="actions">
        <button class="btn btn-warning" onclick="sendSelectedDryRun()">
            üìß Envoyer Emails de Test (Simulation)
        </button>
        <button class="btn btn-danger" onclick="sendSelectedReal()">
            üìß Envoyer Emails R√©els
        </button>

    </div>
</div>

<div id="report-results" style="display:none; margin-top: 30px;">
    <h2>R√©sultats</h2>
    <div id="results-content"></div>
</div>

<hr>

<div class="report-section">
    <h2>üìä Synchronisation Excel</h2>
    <p>Exporter/importer les donn√©es depuis/vers un fichier Excel partag√© sur OneDrive.</p>
    
    <div class="sync-status" id="syncStatus" style="background: #f0f0f0; padding: 15px; border-radius: 5px; margin-bottom: 15px; display: none;">
        <p id="syncStatusText"></p>
    </div>
    
    <div class="actions">
        <button class="btn btn-primary" onclick="checkSyncStatus()">
            üîÑ V√©rifier l'√©tat
        </button>
        <button class="btn btn-success" onclick="exportToExcel()">
            üíæ Exporter vers Excel
        </button>
        <button class="btn btn-info" onclick="importFromExcel()">
            üì• Importer depuis Excel
        </button>
        <a href="/api/excel/download" 
           class="btn btn-secondary" id="downloadBtn" style="display:none;" download="teaching_software.xlsx">
            ‚¨áÔ∏è T√©l√©charger le fichier Excel
        </a>
    </div>
</div>

<hr>

<div class="report-section">
    <h2>Rapport R√©capitulatif</h2>
    <p>G√©n√©rer un inventaire complet de tous les enseignants, modules et logiciels.</p>
    <button class="btn btn-primary" onclick="generateSummaryReport()">
        üìä G√©n√©rer Rapport R√©capitulatif
    </button>
</div>

<div id="summary-report" style="display:none; margin-top: 30px;">
    <h2>Rapport R√©capitulatif</h2>
    <pre id="summary-content"></pre>
</div>

<!-- Modal SMTP s√©curis√© -->
<div id="smtpModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeSmtpModal()">&times;</span>
        <h3>Identifiants SMTP</h3>
        <form onsubmit="submitSmtpCredentials(event)">
            <div class="form-group">
                <label for="smtp_username">Identifiant (ex: prenom.nom@univ-lr.fr)</label>
                <input type="text" id="smtp_username" required>
            </div>
            <div class="form-group">
                <label for="smtp_password">Mot de passe SMTP</label>
                <input type="password" id="smtp_password" required>
            </div>
            <div class="actions" style="margin-top: 10px;">
                <button type="submit" class="btn btn-danger">Envoyer</button>
                <button type="button" class="btn" onclick="closeSmtpModal()">Annuler</button>
            </div>
        </form>
    </div>
</div>

<script>
function getSelectedInstructors() {
    const checkboxes = document.querySelectorAll('.instructor-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

let pendingRealInstructorIds = [];

function sendSelectedDryRun() {
    const selected = getSelectedInstructors();
    if (selected.length === 0) {
        alert('Veuillez s√©lectionner au moins un enseignant');
        return;
    }
    
    sendEmails(selected, true);
}

function sendSelectedReal() {
    const selected = getSelectedInstructors();
    if (selected.length === 0) {
        alert('Veuillez s√©lectionner au moins un enseignant');
        return;
    }

    pendingRealInstructorIds = selected;
    document.getElementById('smtp_username').value = '';
    document.getElementById('smtp_password').value = '';
    document.getElementById('smtpModal').style.display = 'block';
}

function closeSmtpModal() {
    document.getElementById('smtpModal').style.display = 'none';
}

function submitSmtpCredentials(event) {
    event.preventDefault();
    const username = document.getElementById('smtp_username').value.trim();
    const password = document.getElementById('smtp_password').value;

    if (!username || !password) {
        alert('Identifiant et mot de passe requis');
        return;
    }

    closeSmtpModal();
    sendEmails(pendingRealInstructorIds, false, username, password);
}

function sendEmails(instructorIds, dryRun, smtpUser = null, smtpPass = null) {
    const resultsDiv = document.getElementById('report-results');
    const content = document.getElementById('results-content');
    
    resultsDiv.style.display = 'block';
    content.innerHTML = '<p>Traitement en cours...</p>';
    
    let completed = 0;
    let results = [];
    let emailPreviews = [];
    
    instructorIds.forEach(instId => {
        const payload = { dry_run: dryRun };
        if (!dryRun) {
            payload.smtp_username = smtpUser;
            payload.smtp_password = smtpPass;
        }
        
        fetch(`/api/send-reminder/${instId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            completed++;
            
            if (data.success) {
                results.push(`[OK] ${instId}: ${data.message}`);
                if (dryRun && data.preview) {
                    emailPreviews.push(data.preview);
                }
            } else {
                results.push(`[ERREUR] ${instId}: ${data.error}`);
            }
            
            if (completed === instructorIds.length) {
                let html = '<pre>' + results.join('\n') + '</pre>';
                
                // Si dry run, afficher un bouton pour voir les aper√ßus
                if (dryRun && emailPreviews.length > 0) {
                    html += `<button class="btn btn-primary" onclick="showEmailPreviews()" style="margin-top: 10px;">üìß Voir les aper√ßus d‚Äôemails (${emailPreviews.length})</button>`;
                    window.emailPreviews = emailPreviews; // Stocker globalement
                }
                
                content.innerHTML = html;
            }
        })
        .catch(error => {
            completed++;
            results.push(`[ERREUR] ${instId}: ${error.message}`);
            
            if (completed === instructorIds.length) {
                content.innerHTML = '<pre>' + results.join('\n') + '</pre>';
            }
        });
    });
}

function showEmailPreviews() {
    if (!window.emailPreviews) return;
    
    const previewWindow = window.open('', 'Aper√ßu Emails', 'width=900,height=700,scrollbars=yes');
    let html = `
        <html>
        <head>
            <title>Aper√ßu des e-mails</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
                .preview-container { background: white; margin-bottom: 20px; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                .email-header { background: #f0f0f0; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
                .email-body { border: 1px solid #ddd; padding: 20px; border-radius: 5px; background: white; }
                h2 { color: #333; }
            </style>
        </head>
        <body>
            <h1>üìß Aper√ßu des e-mails (simulation) - ${window.emailPreviews.length} e-mail(s)</h1>
    `;
    
    window.emailPreviews.forEach((preview, index) => {
        html += `
            <div class="preview-container">
                <h2>E-mail n¬∞${index + 1}</h2>
                <div class="email-header">
                    <p><strong>De :</strong> ${preview.from || '‚Äî'}</p>
                    <p><strong>√Ä:</strong> ${preview.to}</p>
                    <p><strong>Sujet :</strong> ${preview.subject}</p>
                </div>
                <div class="email-body">
                    ${preview.html || preview.full_body || ''}
                </div>
            </div>
        `;
    });
    
    html += '</body></html>';
    previewWindow.document.write(html);
}

function generateSummaryReport() {
    fetch('/api/summary-report')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('summary-report');
                const content = document.getElementById('summary-content');
                
                content.textContent = data.report;
                container.style.display = 'block';
                container.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Erreur : ' + data.error);
            }
        });
}

function checkSyncStatus() {
    fetch('/api/excel/status')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.status) {
                const status = data.status;
                
                // Ensure status has expected structure
                if (!status.yaml || !status.excel) {
                    throw new Error('Structure de statut invalide : √©l√©ments yaml ou excel manquants');
                }
                
                let html = '<strong>√âtat de la synchronisation :</strong><br>';
                html += `YAML : ${status.yaml.instructors} enseignants, ${status.yaml.modules} modules<br>`;
                html += `Excel : ${status.excel.instructors} enseignants, ${status.excel.modules} modules<br>`;
                html += `<small>Fichier: ${status.excel_path}</small>`;
                
                if (status.error) {
                    html += `<br><small style="color: red;">‚ö†Ô∏è ${status.error}</small>`;
                }
                
                document.getElementById('syncStatusText').innerHTML = html;
                document.getElementById('syncStatus').style.display = 'block';
                
                // Show download button if Excel file exists
                if (status.excel_exists) {
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                }
            } else {
                alert('Erreur : ' + (data.error || 'Erreur inconnue'));
            }
        })
        .catch(err => {
            alert('Erreur lors de la v√©rification de la synchronisation : ' + err.message);
        });
}

function exportToExcel() {
    if (!confirm('Exporter les donn√©es actuelles vers Excel ?')) return;
    
    fetch('/api/excel/export', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('‚úì ' + data.message);
                checkSyncStatus();
            } else {
                alert('‚úó Erreur : ' + (data.error || 'Erreur inconnue'));
            }
        })
        .catch(err => {
            alert('‚úó Erreur : ' + err.message);
        });
}

function importFromExcel() {
    if (!confirm('Importer les donn√©es depuis Excel vers YAML ? Cette action va remplacer les donn√©es actuelles.')) return;
    
    fetch('/api/excel/import', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('‚úì ' + data.message);
                checkSyncStatus();
                // Reload page after 1 second
                setTimeout(() => location.reload(), 1000);
            } else {
                alert('‚úó Erreur : ' + data.error);
            }
        });
}
</script>
{% endblock %}

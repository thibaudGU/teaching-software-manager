{% extends "base.html" %}

{% block content %}
<div class="breadcrumb">
    <a href="{{ url_for('view_instructors') }}">Enseignants</a> &gt; {{ instructor.name }}
</div>

<h1>{{ instructor.name }}</h1>

<div class="instructor-info">
    <p><strong>Email :</strong> <a href="mailto:{{ instructor.email }}">{{ instructor.email }}</a></p>
    <p><strong>Derni√®re r√©vision :</strong> {{ instructor.get('last_review', 'Jamais') }}</p>
</div>

<h2>Modules Assign√©s</h2>

{% if modules %}
<div class="modules-list">
    {% for module in modules %}
    <div class="module-summary">
        <h3>
            <a href="{{ url_for('view_module', module_id=module.id) }}">{{ module.name }}</a>
        </h3>
        <p>{{ module.description }}</p>
        <p><strong>Ann√©e:</strong> {{ module.get('year', '?') }} | <strong>Semestre:</strong> {{ module.get('semester', '?') }}</p>
        <p><strong>Logiciels:</strong> {{ module.software|length }}</p>
        
        <h4>Logiciels requis:</h4>
        <ul>
            {% for software in module.software %}
            <li>
                {{ software.name }} (v{{ software.version }})
                {% if software.get('critical', False) %}
                <span style="color: red; font-weight: bold;">‚ö† CRITIQUE</span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        
        <p><a href="{{ url_for('view_verification') }}" class="btn btn-primary">üîç Modifier les logiciels et OS</a></p>
    </div>
    {% endfor %}
</div>
{% else %}
<p>Aucun module assign√© √† cet enseignant.</p>
{% endif %}

<div class="actions">
    <h2>Actions</h2>
    <button class="btn btn-primary" onclick="generateReport('{{ instructor_id }}')">
        üìä G√©n√©rer un Rapport
    </button>
    <button class="btn btn-warning" onclick="sendReminder('{{ instructor_id }}', true)">
        üìß Envoyer Email de Test (Simulation)
    </button>
    <button class="btn btn-danger" onclick="sendReminder('{{ instructor_id }}', false)">
        üìß Envoyer Email
    </button>
</div>

<div id="report-container" style="display:none; margin-top: 30px;">
    <h2>Rapport g√©n√©r√©</h2>
    <iframe id="report-frame" style="width: 100%; height: 600px; border: 1px solid #ddd;"></iframe>
</div>

<script>
function generateReport(instructorId) {
    fetch(`/api/instructor/${instructorId}/report`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('report-container');
                const frame = document.getElementById('report-frame');
                
                frame.srcdoc = data.html;
                container.style.display = 'block';
                
                // Scroll to report
                container.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Erreur : ' + data.error);
            }
        });
}

function sendReminder(instructorId, dryRun) {
    if (dryRun) {
        // Dry run - pas besoin d'identifiants
        fetch(`/api/send-reminder/${instructorId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ dry_run: true })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.preview) {
                // Afficher le template email dans une nouvelle fen√™tre
                const previewWindow = window.open('', 'Email Preview', 'width=800,height=600,scrollbars=yes');
                previewWindow.document.write(`
                    <html>
                    <head>
                        <title>Email Preview - ${data.preview.subject}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .email-header { background: #f0f0f0; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
                            .email-body { border: 1px solid #ddd; padding: 20px; border-radius: 5px; }
                        </style>
                    </head>
                    <body>
                        <h2>üìß Aper√ßu Email (Dry Run)</h2>
                        <div class="email-header">
                            <p><strong>De:</strong> ${data.preview.from || '‚Äî'}</p>
                            <p><strong>√Ä:</strong> ${data.preview.to}</p>
                            <p><strong>Sujet:</strong> ${data.preview.subject}</p>
                        </div>
                        <div class="email-body">
                            ${data.preview.html}
                        </div>
                    </body>
                    </html>
                `);
            } else {
                alert('‚úì ' + (data.message || 'Aper√ßu g√©n√©r√©'));
            }
        })
        .catch(err => alert('‚úó Erreur: ' + err.message));
    } else {
        // Envoi r√©el - modal avec mot de passe masqu√©
        askSmtpCredentials().then(creds => {
            if (!creds) return;

            fetch(`/api/send-reminder/${instructorId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    dry_run: false,
                    smtp_username: creds.username,
                    smtp_password: creds.password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úì ' + data.message);
                } else {
                    alert('‚úó Erreur: ' + (data.error || '√âchec de l\'envoi'));
                }
            })
            .catch(err => alert('‚úó Erreur: ' + err.message));
        });
    }
}

// Modale simple pour saisir identifiant + mot de passe (mot de passe masqu√©)
function askSmtpCredentials() {
    return new Promise(resolve => {
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.background = 'rgba(0,0,0,0.4)';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.zIndex = '9999';

        const modal = document.createElement('div');
        modal.style.background = '#fff';
        modal.style.padding = '20px';
        modal.style.borderRadius = '8px';
        modal.style.width = '320px';
        modal.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';

        modal.innerHTML = `
            <h3>Identifiants SMTP</h3>
            <div class="form-group">
                <label>Identifiant (ex: prenom.nom@univ-lr.fr)</label>
                <input type="text" id="smtp_user_input" style="width: 100%; padding: 8px; margin: 5px 0;" />
            </div>
            <div class="form-group">
                <label>Mot de passe</label>
                <input type="password" id="smtp_pass_input" style="width: 100%; padding: 8px; margin: 5px 0;" />
            </div>
            <div style="text-align: right; margin-top: 10px;">
                <button id="smtp_cancel_btn" class="btn" style="margin-right: 8px;">Annuler</button>
                <button id="smtp_ok_btn" class="btn btn-primary">Continuer</button>
            </div>
        `;

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        const cleanup = () => overlay.remove();

        modal.querySelector('#smtp_cancel_btn').onclick = () => {
            cleanup();
            resolve(null);
        };

        modal.querySelector('#smtp_ok_btn').onclick = () => {
            const username = modal.querySelector('#smtp_user_input').value.trim();
            const password = modal.querySelector('#smtp_pass_input').value;
            if (!username || !password) {
                alert('Identifiant et mot de passe requis');
                return;
            }
            cleanup();
            resolve({ username, password });
        };
    });
}
</script>
{% endblock %}
